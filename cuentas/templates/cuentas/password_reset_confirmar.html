{% extends "cuentas/base_cuentas.html" %}

{% load static %}
{% block title %}Restablecer Contraseña{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
    /* Ocultar navbar y footer en esta página */
    .site-footer,
    header,
    footer {
        display: none !important;
    }

    /* Ocultar navbar pero permitir mostrar solo la marca */
    .navbar {
        visibility: hidden !important;
        height: 0 !important;
        padding: 0 !important;
        margin: 0 !important;
        overflow: visible !important;
    }

    /* Mostrar SOLO el navbar-brand */
    .navbar .navbar-brand {
        visibility: visible !important;
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999;
        font-size: 12px;
        color: #ffffff !important;
        opacity: 0.8;
    }

    /* Hacer que el contenedor principal ocupe todo sin márgenes */
    main.container,
    main {
        max-width: 100% !important;
        padding: 0 !important;
        margin: 0 !important;
    }

    html {
        overflow: hidden;
    }

    body {
        background: radial-gradient(circle at top, #2c1e5e 0, #020617 45%, #020617 100%);
        margin: 0;
        padding: 0;
        overflow: hidden;
        font-family: 'Arial', sans-serif;
    }

    .reset-password-wrapper {
        min-height: 100vh;
        max-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem 1rem;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .card-reset-password {
        border: none;
        border-radius: 1.4rem;
        background: radial-gradient(circle at top,
                    rgba(2, 11, 32, 0.678),
                    rgba(15, 23, 42, 0.96));
        backdrop-filter: blur(14px);
        box-shadow: 0 20px 40px rgba(15, 23, 42, 0.55);
        color: #e5e7eb;
        overflow: hidden;
        max-width: 550px;
        width: 100%;
    }

    .card-header-custom {
        padding: 1.6rem 1.7rem 1.1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        border-bottom: 1px solid rgba(148, 163, 184, 0.25);
        background: transparent;
    }

    .icon-ring {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: radial-gradient(circle at 30% 20%,
                    rgba(250, 250, 255, 0.18),
                    rgba(15, 23, 42, 0.9));
        box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.25);
        flex-shrink: 0;
    }

    .icon-ring i {
        font-size: 1.7rem;
        color: #facc15;
    }

    .card-header-custom h5 {
        margin: 0;
        font-weight: 600;
        color: #ffffff;
    }

    .card-body-custom {
        padding: 1.7rem 1.7rem 1.45rem;
    }

    .alert-custom {
        border-radius: .8rem;
        padding: 1rem;
        border: none;
        margin-bottom: 1.2rem;
    }

    .alert-danger-custom {
        background: rgba(220, 38, 38, 0.15);
        color: #fca5a5;
        border-left: 3px solid #dc2626;
    }

    .alert-success-custom {
        background: rgba(34, 197, 94, 0.15);
        color: #86efac;
        border-left: 3px solid #22c55e;
    }

    .alert-custom ul {
        margin-bottom: 0;
        padding-left: 1.2rem;
    }

    .form-label-custom {
        font-size: .85rem;
        font-weight: 500;
        color: #e5e7eb;
        margin-bottom: .5rem;
    }

    .input-group-custom {
        position: relative;
        margin-bottom: 1.2rem;
    }

    .form-control-custom {
        background-color: rgba(15, 23, 42, 0.9);
        border-radius: .8rem;
        border: 1px solid #1f2937;
        color: #e5e7eb;
        font-size: .9rem;
        padding: .75rem 3rem .75rem 1rem;
        width: 100%;
    }

    .form-control-custom:focus {
        background-color: rgba(15, 23, 42, 0.98);
        border-color: #3b82f6;
        box-shadow: 0 0 0 .12rem rgba(59,130,246,.38);
        color: #e5e7eb;
        outline: none;
    }

    .form-control-custom:disabled {
        background-color: rgba(15, 23, 42, 0.5);
        color: #9ca3af;
        cursor: not-allowed;
    }

    .toggle-password-btn {
        position: absolute;
        right: .75rem;
        top: 50%;
        transform: translateY(-50%);
        background: transparent;
        border: none;
        color: #6b7280;
        cursor: pointer;
        padding: .25rem .5rem;
        transition: color 0.3s ease;
    }

    .toggle-password-btn:hover {
        color: #3b82f6;
    }

    .btn-primary-custom {
        border-radius: .9rem;
        padding: .75rem 1.2rem;
        font-weight: 600;
        letter-spacing: .02em;
        border: none;
        background: linear-gradient(135deg, #2563eb, #4f46e5);
        box-shadow: 0 12px 25px rgba(37, 99, 235, 0.45);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: .4rem;
        width: 100%;
        color: #ffffff;
        transition: all 0.3s ease;
    }

    .btn-primary-custom:hover {
        background: linear-gradient(135deg, #1d4ed8, #4338ca);
        transform: translateY(-1px);
        box-shadow: 0 16px 30px rgba(37, 99, 235, 0.55);
    }

    .btn-outline-custom {
        border-radius: .9rem;
        padding: .6rem 1.2rem;
        font-weight: 600;
        border: 2px solid rgba(59, 130, 246, 0.5);
        background: transparent;
        color: #3b82f6;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: .4rem;
        text-decoration: none;
        transition: all 0.3s ease;
    }

    .btn-outline-custom:hover {
        background: rgba(59, 130, 246, 0.1);
        border-color: #3b82f6;
        color: #60a5fa;
    }

    .success-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: rgba(34, 197, 94, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
    }

    .success-icon i {
        font-size: 2.5rem;
        color: #22c55e;
    }

    .error-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: rgba(220, 38, 38, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
    }

    .error-icon i {
        font-size: 2.5rem;
        color: #dc2626;
    }

    .text-center-custom {
        text-align: center;
    }

    .mb-custom {
        margin-bottom: 1.5rem;
    }

    /* Responsive */
    @media (max-width: 575.98px) {
        .reset-password-wrapper {
            padding: 1.5rem 1rem;
        }

        .card-reset-password {
            border-radius: 1rem;
        }

        .card-header-custom {
            flex-direction: column;
            text-align: center;
            padding: 1.5rem 1.2rem 1rem;
        }

        .card-body-custom {
            padding: 1.5rem 1.2rem;
        }
    }
</style>

<div class="reset-password-wrapper">
    <div class="card-reset-password">
        {% if estado == "error" %}
            <div class="card-header-custom">
                <div class="icon-ring">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                </div>
                <div>
                    <h5 class="mb-0">Error en el enlace</h5>
                </div>
            </div>
            <div class="card-body-custom text-center-custom">
                <div class="error-icon">
                    <i class="fa-solid fa-xmark"></i>
                </div>
                <div class="alert-custom alert-danger-custom">
                    {{ mensaje }}
                </div>
                <a href="{% url 'cuentas:olvide_password_html' %}" class="btn-outline-custom">
                    <i class="fa-solid fa-arrow-left"></i> Solicitar un nuevo enlace
                </a>
            </div>

        {% elif estado == "ok" %}
            <div class="card-header-custom">
                <div class="icon-ring">
                    <i class="fa-solid fa-check"></i>
                </div>
                <div>
                    <h5 class="mb-0">¡Contraseña actualizada!</h5>
                </div>
            </div>
            <div class="card-body-custom text-center-custom">
                <div class="success-icon">
                    <i class="fa-solid fa-check"></i>
                </div>
                <div class="alert-custom alert-success-custom mb-custom">
                    {{ mensaje }}
                </div>
                <a href="{% url 'aplicacion:login' %}" class="btn-primary-custom">
                    <i class="fa-solid fa-arrow-right-to-bracket"></i> Ir al inicio de sesión
                </a>
            </div>

        {% else %}
            <div class="card-header-custom">
                <div class="icon-ring">
                    <i class="fa-solid fa-lock-open"></i>
                </div>
                <div>
                    <h5 class="mb-0">Crear nueva contraseña</h5>
                </div>
            </div>
            <div class="card-body-custom">
            {% if errores %}
            <div class="alert-custom alert-danger-custom">
                <ul>
                {% for campo, msgs in errores.items %}
                    <li>{{ msgs|join:", " }}</li>
                {% endfor %}
                </ul>
            </div>
            {% endif %}


                <form method="post" novalidate>
                    {% csrf_token %}
                    <input type="hidden" name="token" value="{{ token }}">

                    {% if correo %}
                    <div class="mb-custom">
                        <label class="form-label-custom">Correo electrónico</label>
                        <input type="email" class="form-control-custom" value="{{ correo }}" disabled>
                    </div>
                    {% endif %}

                    <div class="mb-custom">
                        <label for="password1" class="form-label-custom">Nueva contraseña</label>
                        <div class="input-group-custom">
                            <input type="password" id="password1" name="password1" 
                                   class="form-control-custom" required minlength="6"
                                   placeholder="Ingresa tu nueva contraseña">
                            <button class="toggle-password-btn" type="button" id="togglePwd1">
                                <i class="fa fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mb-custom">
                        <label for="password2" class="form-label-custom">Confirmar contraseña</label>
                        <div class="input-group-custom">
                            <input type="password" id="password2" name="password2" 
                                   class="form-control-custom" required minlength="6"
                                   placeholder="Confirma tu nueva contraseña">
                            <button class="toggle-password-btn" type="button" id="togglePwd2">
                                <i class="fa fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <button type="submit" class="btn-primary-custom">
                        <i class="fa-solid fa-floppy-disk"></i> Guardar contraseña
                    </button>
                </form>
            </div>
        {% endif %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  // Mostrar/ocultar contraseñas
  const togglePwd1 = document.getElementById('togglePwd1');
  const togglePwd2 = document.getElementById('togglePwd2');
  const pwd1 = document.getElementById('password1');
  const pwd2 = document.getElementById('password2');

  if (togglePwd1 && pwd1) {
    togglePwd1.addEventListener('click', () => {
      const type = pwd1.type === 'password' ? 'text' : 'password';
      pwd1.type = type;
      togglePwd1.querySelector('i').classList.toggle('fa-eye');
      togglePwd1.querySelector('i').classList.toggle('fa-eye-slash');
    });
  }
  if (togglePwd2 && pwd2) {
    togglePwd2.addEventListener('click', () => {
      const type = pwd2.type === 'password' ? 'text' : 'password';
      pwd2.type = type;
      togglePwd2.querySelector('i').classList.toggle('fa-eye');
      togglePwd2.querySelector('i').classList.toggle('fa-eye-slash');
    });
  }

  // SweetAlert para mensajes globales
  {% if estado == "ok" %}
  Swal.fire({
    icon: "success",
    title: "¡Contraseña actualizada!",
    text: "{{ mensaje|escapejs }}",
    confirmButtonText: "Ir al login",
    confirmButtonColor: "#2563eb"
  }).then(() => {
    window.location.href = "{% url 'aplicacion:login' %}";
  });
  {% endif %}
</script>
{% endblock %}