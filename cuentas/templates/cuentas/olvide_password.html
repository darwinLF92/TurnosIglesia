{% extends "cuentas/base_cuentas.html" %}

{% block title %}Olvidé mi contraseña{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
    /* Ocultar navbar y footer en esta página */
    nav.navbar,
    .site-footer,
    header,
    footer {
        display: none !important;
    }

    /* Hacer que el contenedor principal ocupe todo sin márgenes */
    main.container,
    main {
        max-width: 100% !important;
        padding: 0 !important;
        margin: 0 !important;
    }

    body {
        background: radial-gradient(circle at top, #2c1e5e 0, #020617 45%, #020617 100%);
        margin: 0;
        padding: 0;
        overflow: hidden; /* Evita scroll en el body */
    }

    .reset-wrapper {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem 1rem;
    }

    .card-reset {
        border: none;
        border-radius: 1.4rem;
        background: radial-gradient(circle at top,
                    rgba(2, 11, 32, 0.678),
                    rgba(15, 23, 42, 0.96));
        backdrop-filter: blur(14px);
        box-shadow: 0 20px 40px rgba(15, 23, 42, 0.55);
        color: #e5e7eb;
        overflow: hidden;
        max-width: 500px;
        width: 100%;
    }

    .card-reset-header {
        padding: 1.6rem 1.7rem 1.1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        border-bottom: 1px solid rgba(148, 163, 184, 0.25);
    }

    .card-reset-header .icon-ring {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: radial-gradient(circle at 30% 20%,
                    rgba(250, 250, 255, 0.18),
                    rgba(15, 23, 42, 0.9));
        box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.25);
        flex-shrink: 0;
    }

    .card-reset-header .icon-ring i {
        font-size: 1.7rem;
        color: #facc15;
    }

    .card-reset-header h5 {
        margin: 0;
        font-weight: 600;
    }

    .card-reset-header small {
        font-size: .8rem;
        color: #9ca3af;
        display: block;
        margin-top: 0.25rem;
    }

    .card-reset-body {
        padding: 1.7rem 1.7rem 1.45rem;
    }

    .form-label {
        font-size: .85rem;
        font-weight: 500;
        color: #e5e7eb;
    }

    .input-group-reset {
        position: relative;
    }

    .input-group-reset .input-icon {
        position: absolute;
        inset-block: 0;
        left: .75rem;
        display: flex;
        align-items: center;
        color: #6b7280;
        pointer-events: none;
    }

    .input-group-reset .form-control {
        padding-left: 2.3rem;
    }

    .form-control {
        background-color: rgba(15, 23, 42, 0.9);
        border-radius: .8rem;
        border: 1px solid #1f2937;
        color: #e5e7eb;
        font-size: .9rem;
    }

    .form-control:focus {
        background-color: rgba(15, 23, 42, 0.98);
        border-color: #3b82f6;
        box-shadow: 0 0 0 .12rem rgba(59,130,246,.38);
        color: #e5e7eb;
    }

    .helper-text {
        font-size: .78rem;
        color: #9ca3af;
    }

    .btn-reset {
        border-radius: .9rem;
        padding: .6rem 1.2rem;
        font-weight: 600;
        letter-spacing: .02em;
        border: none;
        background: linear-gradient(135deg, #2563eb, #4f46e5);
        box-shadow: 0 12px 25px rgba(37, 99, 235, 0.45);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: .4rem;
    }

    .btn-reset:hover {
        background: linear-gradient(135deg, #1d4ed8, #4338ca);
        transform: translateY(-1px);
        box-shadow: 0 16px 30px rgba(37, 99, 235, 0.55);
    }

    .btn-reset .spinner-border {
        width: 1rem;
        height: 1rem;
        border-width: .12rem;
    }

    @media (prefers-color-scheme: light) {
        .card-reset {
            background: #09113f94;
            box-shadow: 0 18px 32px rgba(15, 23, 42, 0.18);
            color: #111827;
        }
        .card-reset-header {
            border-bottom-color: rgba(148, 163, 184, 0.35);
        }
        .form-label {
            color: #ced3df;
        }
        .form-control {
            background-color: #f9fafb;
            color: #111827;
            border-color: #d1d5db;
        }
        .helper-text {
            color: #6b7280;
        }
        h5{
            color: #d8d9dd;
        }
    }

    /* ⚡ Ajuste para móviles */
    @media (max-width: 575.98px) {
        .reset-wrapper {
            min-height: 100vh;
            padding: 1.5rem 1rem;
        }

        .card-reset {
            border-radius: 1rem;
        }

        .card-reset-header {
            flex-direction: column;
            text-align: center;
            padding: 1.5rem 1.2rem 1rem;
        }

        .card-reset-body {
            padding: 1.5rem 1.2rem;
        }
    }
</style>

<div class="reset-wrapper">
    <div class="card card-reset">
        <div class="card-reset-header">
            <div class="icon-ring">
                <i class="fa-solid fa-key"></i>
            </div>
            <div>
                <h5 class="mb-0">¿Olvidaste tu contraseña?</h5>
                <small>
                    Escribe tu correo y te enviaremos un enlace para crear una nueva contraseña.
                </small>
            </div>
        </div>

        <div class="card-reset-body">
            <form id="olvidePassForm" autocomplete="off">
                {% csrf_token %}

                <div class="mb-3">
                    <label for="correo" class="form-label">Correo electrónico</label>
                    <div class="input-group-reset">
                        <span class="input-icon">
                            <i class="fa-regular fa-envelope"></i>
                        </span>
                        <input type="email"
                               class="form-control"
                               id="correo"
                               name="correo"
                               required
                               maxlength="50">
                    </div>
                    <div class="helper-text mt-1">
                        Debe ser el correo con el que estás registrado en el sistema.
                    </div>
                </div>

                <div class="d-grid mt-3">
                    <button type="submit" class="btn btn-reset" id="btnEnviar">
                        <span class="btn-text">Enviar enlace</span>
                        <span class="spinner-border text-light d-none" role="status" aria-hidden="true"></span>
                    </button>
                </div>
            </form>

            <p class="mt-3 mb-0 helper-text text-center">
                Si el correo existe y está activo, recibirás un enlace para restablecer tu contraseña.
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie("csrftoken");

const form = document.getElementById("olvidePassForm");
const btnEnviar = document.getElementById("btnEnviar");
const btnText = btnEnviar.querySelector(".btn-text");
const btnSpinner = btnEnviar.querySelector(".spinner-border");

form.addEventListener("submit", async function(e) {
    e.preventDefault();

    const correo = document.getElementById("correo").value.trim();

    if (!correo) {
        Swal.fire({
            icon: "warning",
            title: "Correo requerido",
            text: "Ingresa tu correo electrónico.",
        });
        return;
    }

    btnEnviar.disabled = true;
    btnText.textContent = "Enviando...";
    btnSpinner.classList.remove("d-none");

    try {
        const resp = await fetch("{% url 'cuentas:api_olvide_password' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken,
            },
            body: JSON.stringify({ correo }),
        });

        if (resp.ok) {
            Swal.fire({
                icon: "success",
                title: "Solicitud recibida",
                text: "Si el correo existe y es válido, recibirás un enlace para restablecer tu contraseña.",
                showCancelButton: true,
                confirmButtonText: "Ir al inicio",
                cancelButtonText: "Cerrar",
                reverseButtons: true,
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = "{% url 'aplicacion:home' %}";
                }
            });

            form.reset();

        } else {
            const data = await resp.json();
            let msg = "";
            for (const campo in data) {
                msg += `${campo}: ${data[campo]} \n`;
            }
            Swal.fire({
                icon: "error",
                title: "No se pudo procesar la solicitud",
                text: msg || "Ocurrió un error al procesar tu petición."
            });
        }
    } catch (err) {
        console.error(err);
        Swal.fire({
            icon: "error",
            title: "Error inesperado",
            text: "Ocurrió un error al enviar la solicitud. Intenta nuevamente.",
        });
    } finally {
        btnEnviar.disabled = false;
        btnText.textContent = "Enviar enlace";
        btnSpinner.classList.add("d-none");
    }
});
</script>
{% endblock %}