{% extends "cuentas/base_cuentas.html" %}

{% block title %}Registro de usuario{% endblock %}

{% block content %}
<style>

/* ===== ESTILO DEL LOGIN APLICADO AL REGISTRO ===== */

body {
    background: linear-gradient(160deg, #10132f, #06060f);
    font-family: "Arial", sans-serif;
}

.registro-container {
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.registro-card {
    width: 100%;
    max-width: 420px;
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(14px);
    border-radius: 18px;
    padding: 25px 25px 35px;
    border: 1px solid rgba(255,255,255,0.12);
    box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    text-align: center;
}

/* ===== LOGO ===== */
.registro-logo-wrapper {
    display: flex;
    justify-content: center;
    margin-bottom: 10px;
}

.registro-logo-wrapper .logo-container {
    background: #ffffff22;
    padding: 12px;
    border-radius: 50%;
    box-shadow: 0 0 12px rgba(255, 255, 255, .18);
}

.registro-logo-wrapper img {
    width: 100px;
    height: 100px;
    border-radius: 50%;
}

/* ===== TITULOS ===== */
.registro-card h2 {
    color: #fff;
    font-size: 22px;
    margin-top: 10px;
    margin-bottom: 5px;
}

.registro-card p {
    color: #ccc;
    font-size: 14px;
    margin-bottom: 20px;
}

/* ===== INPUTS ===== */
.form-control,
.input-group-text {
    background: rgba(255,255,255,0.15) !important;
    border: 1px solid rgba(255,255,255,0.2) !important;
    color: #fff !important;
    border-radius: 10px !important;
}

/* ===== LABELS A LA IZQUIERDA ===== */
.form-label {
    color: #e2e2e2 !important;
    font-weight: 600;
    margin-bottom: 4px;
    text-align: left !important;   /* üëà fuerza alineaci√≥n a la izquierda */
    display: block;                /* üëà evita centrado por contenedor */
    width: 100%;
}

.helper-text {
    font-size: 12px;
    color: #c8c8c8;
}

/* Input-group contenedor */
.input-group {
    width: 100%;
}

/* Tel√©fono: input recto a la derecha */
.input-group .form-control {
    border-radius: 0 10px 10px 0 !important;
}

/* Prefijo +502 */
.input-group-text {
    border-radius: 10px 0 0 10px !important;
    font-weight: bold;
}


/* ===== BOT√ìN REGISTRO FULL WIDTH ===== */
.btn-primary {
    background: #1a2cff;
    border: none;
    width: 100%;                /* üëà full width real */
    padding: 12px;
    font-size: 16px;
    border-radius: 10px;
    margin-top: 10px;
}

.btn-primary:hover {
    background: #1320c7;
}

/* ===== BOT√ìN REGRESAR FULL WIDTH ===== */
.btn-regresar {
    display: block;
    width: 100%;               /* üëà full width */
    padding: 12px;
    border-radius: 10px;
    font-size: 15px;
    margin-top: 12px;
    text-align: center;
    color: #ccc;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.15);
}

.btn-regresar:hover {
    background: rgba(255,255,255,0.18);
    color: white;
}

</style>

<div class="registro-container">
    <div class="registro-card">

        <!-- Logo -->
        <div class="registro-logo-wrapper">
            <div class="logo-container">
                <img src="{{ logo_url }}" alt="Logo">
            </div>
        </div>

        <h2>Crear cuenta</h2>
        <p>Completa tus datos para registrarte</p>

        <form id="registroForm" autocomplete="off">
            {% csrf_token %}

            <div class="mb-3">
                <label class="form-label">CUI</label>
                <input type="text" class="form-control" id="cui" name="cui" required maxlength="13" inputmode="numeric">
                <div class="helper-text">13 d√≠gitos, solo n√∫meros.</div>
            </div>

            <div class="mb-3">
                <label class="form-label">Usuario</label>
                <input type="text" class="form-control" id="usuario" name="usuario" required maxlength="16">
            </div>

            <div class="mb-3">
                <label class="form-label">Nombres</label>
                <input type="text" class="form-control" id="nombres" name="nombres" required maxlength="50">
            </div>

            <div class="mb-3">
                <label class="form-label">Apellidos</label>
                <input type="text" class="form-control" id="apellidos" name="apellidos" required maxlength="50">
            </div>

            <div class="mb-3">
                <label class="form-label">Direcci√≥n</label>
                <input type="text" class="form-control" id="direccion" name="direccion" maxlength="100">
            </div>

            <div class="mb-3">
                <label class="form-label">Fecha de nacimiento</label>
                <input type="date" class="form-control" id="fecha_nacimiento" name="fecha_nacimiento">
            </div>

            <div class="mb-3">
                <label class="form-label">Estatura (cm)</label>
                <input type="text" class="form-control" id="estatura" name="estatura" maxlength="3">
            </div>

            <div class="mb-3">
                <label class="form-label">Tel√©fono</label>
                <div class="input-group">
                    <span class="input-group-text">+502</span>
                    <input type="text" class="form-control" id="telefono" name="telefono" maxlength="8">
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Correo electr√≥nico</label>
                <input type="email" class="form-control" id="correo" name="correo" required maxlength="50">
            </div>

            <button class="btn btn-primary">Registrarme</button>

            <a href="{% url 'aplicacion:login' %}" class="btn-regresar">‚Üê Regresar</a>

            <p class="mt-3 helper-text">Despu√©s del registro te enviaremos un correo de confirmaci√≥n.</p>

        </form>

    </div>
</div>

{% endblock %}


{% block extra_js %}
<!-- Font Awesome -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/js/all.min.js"></script>
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// =======================
// CSRF
// =======================
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie("csrftoken");

// =======================
// Inputs
// =======================
const cuiInput = document.getElementById("cui");
const usuarioInput = document.getElementById("usuario");
const telefonoInput = document.getElementById("telefono");
const estaturaInput = document.getElementById("estatura");

// =======================
// Limitaciones de UX (no seguridad)
// =======================

// Solo n√∫meros ‚Äì CUI
cuiInput.addEventListener("input", () => {
    cuiInput.value = cuiInput.value.replace(/\D/g, "").slice(0, 13);
});

// Usuario solo letras y n√∫meros
usuarioInput.addEventListener("input", () => {
    usuarioInput.value = usuarioInput.value.replace(/[^A-Za-z0-9]/g, "").slice(0, 16);
});

// Tel√©fono solo n√∫meros
telefonoInput.addEventListener("input", () => {
    telefonoInput.value = telefonoInput.value.replace(/\D/g, "").slice(0, 8);
});

// Estatura solo n√∫meros
estaturaInput.addEventListener("input", () => {
    estaturaInput.value = estaturaInput.value.replace(/\D/g, "").slice(0, 3);
});

// =======================
// Env√≠o del formulario
// =======================
document.getElementById("registroForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const data = {
        cui: cuiInput.value.trim(),
        usuario: usuarioInput.value.trim(),
        nombres: document.getElementById("nombres").value.trim(),
        apellidos: document.getElementById("apellidos").value.trim(),
        direccion: document.getElementById("direccion").value.trim(),
        fecha_nacimiento: document.getElementById("fecha_nacimiento").value || null,
        estatura: estaturaInput.value.trim() || null,
        telefono: telefonoInput.value.trim(),
        correo: document.getElementById("correo").value.trim(),
    };

    // =======================
    // Mostrar SweetAlert "Solicitando Registro..."
    // =======================
    Swal.fire({
        title: "Solicitando Registro...",
        text: "Por favor espera",
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    try {
        const resp = await fetch("{% url 'cuentas:api_registro' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken,
            },
            body: JSON.stringify(data),
        });

        const result = await resp.json();

        if (resp.ok) {
            Swal.fire({
                icon: "success",
                title: "Registro exitoso",
                text: "Revisa tu correo para confirmar tu cuenta.",
                confirmButtonText: "Aceptar"
            });

            e.target.reset();
        } else {
            let errores = "";
            for (const campo in result) {
                errores += `<strong>${campo}:</strong> ${result[campo]}<br>`;
            }

            Swal.fire({
                icon: "error",
                title: "No se pudo completar el registro",
                html: errores || "Ocurri√≥ un error al registrar tus datos.",
            });
        }

    } catch (error) {
        Swal.fire({
            icon: "error",
            title: "Error inesperado",
            text: "Ocurri√≥ un error. Intenta de nuevo m√°s tarde.",
        });
    }
});


</script>
{% endblock %}
