{% extends 'aplicacion/base.html' %}
{% load static %}


{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="{% static 'noticias/css/muro.css' %}">

<style>
footer {
    display: none !important;
}
</style>



<!-- CONTENEDOR PRINCIPAL DEL MURO -->
<div id="posts-container" class="feed-container">
<!-- FORMULARIO PARA CREAR PUBLICACI칍N -->
{% if perms.establecimiento.crear_publicacion %}
<div class="card fb-post-box shadow-sm mb-4">
    <div class="card-body">

        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="d-flex mb-2">
                {% if request.user.perfil.foto_perfil %}
                    <img src="{{ request.user.perfil.foto_perfil.url }}"
                         class="rounded-circle me-2"
                         width="45" height="45"
                         style="object-fit:cover;">
                {% else %}
                    <div class="avatar-inicial me-2
                        {% if request.user.perfil.genero == 'M' %} avatar-m
                        {% elif request.user.perfil.genero == 'F' %} avatar-f
                        {% else %} avatar-o
                        {% endif %}
                    ">
                        {{ request.user.first_name|slice:":1"|upper }}{{ request.user.last_name|slice:":1"|upper }}
                    </div>
                {% endif %}

                {{ form.contenido }}
            </div>

            <div class="fb-actions d-flex justify-content-between p-2 rounded">
                <label class="fb-action-item">
                    <i class="fas fa-image text-success"></i> Foto
                    <input type="file" name="media" multiple accept="image/*,video/*" hidden>
                </label>

                <label class="fb-action-item">
                    <i class="fas fa-video text-danger"></i> Video
                    <input type="file" name="media" multiple accept="image/*,video/*" hidden>
                </label>
            </div>

            <button class="btn btn-primary w-100 mt-3 fw-bold" style="border-radius:20px;">
                Publicar
            </button>
        </form>

    </div>
</div>
{% endif %}


<!-- BUSCADOR -->
<form class="mb-4 buscador" onsubmit="return false;">
    <div class="input-group">
        <input type="text"
               id="search-input"
               class="form-control"
               placeholder="Buscar publicaciones..."
               autocomplete="off">

        <button class="btn btn-primary" type="button" id="search-btn">
            <i class="fas fa-search"></i>
        </button>
    </div>
</form>




    <!-- 游댠 LOADER / SKELETON (SE VE AL INICIO Y EN B칔SQUEDA) -->
    <div id="skeleton-loader">
        {% for i in "12345" %}
        <div class="card fb-post mb-3 p-3 skeleton-card">

            <div class="d-flex mb-3">
                <div class="skeleton avatar"></div>
                <div class="ms-2" style="width:150px;">
                    <div class="skeleton line mb-2"></div>
                    <div class="skeleton line small"></div>
                </div>
            </div>

            <div class="skeleton line mb-2"></div>
            <div class="skeleton line mb-2"></div>
            <div class="skeleton line short"></div>

            <div class="skeleton media mb-2"></div>
        </div>
        {% endfor %}
    </div>

    <!-- Aqu칤 se insertar치n publicaciones din치micamente -->
</div>



<!-- Modal likes -->
<div class="modal fade" id="likesModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content shadow-lg rounded-3 border-0">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-semibold">
          <i class="fas fa-thumbs-up text-primary me-2"></i>
          Personas a las que les gusta esto
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body pt-2" id="likesModalBody" style="max-height:350px; overflow-y:auto;"></div>
      <div class="modal-footer border-0">
        <button class="btn btn-light w-100" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: lista completa de comentarios -->
<div class="modal fade" id="commentsModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title mb-0">
          <i class="fas fa-comments me-2"></i>Todos los comentarios
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="commentsModalBody" style="max-height:75vh; overflow-y:auto;"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal editar publicaci칩n -->
<div class="modal fade" id="modalEditarPost" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Editar publicaci칩n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <form id="formEditarPost" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="modal-body">
          <label class="fw-semibold mb-1">Texto de la publicaci칩n</label>
          <textarea id="editarContenido" class="form-control mb-3" rows="4"></textarea>

          <label class="fw-semibold">Fotos y videos actuales</label>
          <div id="editarMediaActual" class="row g-3 mb-3"></div>

          <label class="fw-semibold">Agregar fotos o videos</label>
          <input type="file" name="nuevo_media" id="nuevoMedia"
                 class="form-control" multiple accept="image/*,video/*">
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Swiper galer칤a -->
<div class="modal fade" id="modalSwiperGallery" tabindex="-1">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content bg-dark">
      <div class="modal-header border-0">
        <button class="btn btn-light" data-bs-dismiss="modal">Cerrar</button>
      </div>
      <div class="modal-body p-0">
        <div class="swiper mySwiper">
          <div class="swiper-wrapper" id="swiperContent"></div>
          <div class="swiper-button-next"></div>
          <div class="swiper-button-prev"></div>
          <div class="swiper-pagination"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Swiper -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

{# URLs din치micas para usarlas en el JS est치tico #}
<script>
  window.NEWS_URLS = {
    toggleLike: "{% url 'noticias:toggle_like' 0 %}",
    listaLikes: "{% url 'noticias:lista_likes' 0 %}",
    listaComentarios: "{% url 'noticias:lista_comentarios' 0 %}",
    toggleLikeComentario: "{% url 'noticias:toggle_like_comentario' 0 %}",
    responderComentario: "{% url 'noticias:responder_comentario' 0 %}"
  };
</script>

<script src="{% static 'noticias/js/muro.js' %}"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    if (window.location.hash.startsWith("#post-")) {
        const post = document.querySelector(window.location.hash);
        if (post) {
            post.scrollIntoView({ behavior: "smooth", block: "start" });
        }
    }
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {

    const input = document.getElementById("search-input");
    const contenedor = document.getElementById("posts-container");
    const skeleton = document.getElementById("skeleton-loader");

    let currentPage = 1;
    let cargando = false;
    let modoBusqueda = false;

    function limpiarPosts() {
        contenedor.querySelectorAll(".card.fb-post").forEach(e => e.remove());
        skeleton.style.display = "block"; // mostrar loader
    }

    function cargarPagina(page = 1, q = "") {

        if (cargando) return;
        cargando = true;

        skeleton.style.display = "block"; // mostrar loader

        const url = "{% url 'noticias:buscar_publicaciones' %}"
            + `?page=${page}`
            + (q ? `&q=${encodeURIComponent(q)}` : "")
            + "&infinite=1";

        fetch(url)
        .then(r => r.json())
        .then(data => {

            contenedor.insertAdjacentHTML("beforeend", data.html);

            skeleton.style.display = "none"; // ocultar loader

            cargando = false;
            currentPage = page;
            window.hasNext = data.has_next;
            window.nextPage = data.next_page;
        });
    }

    // CARGA INICIAL
    cargarPagina(1);

    // ============ B칔SQUEDA AJAX ===============
    function debounce(fn, delay) {
        let timer;
        return function(...args) {
            clearTimeout(timer);
            timer = setTimeout(() => fn.apply(this, args), delay);
        };
    }

    input.addEventListener("input", debounce(function () {

        const term = this.value.trim();

        if (term === "") {

            modoBusqueda = false;
            history.replaceState(null, "", window.location.pathname);

            limpiarPosts();
            cargarPagina(1);

            window.scrollTo({ top: 0, behavior: "smooth" });
            return;
        }

        modoBusqueda = true;
        limpiarPosts();

        fetch("{% url 'noticias:buscar_publicaciones' %}?q=" + encodeURIComponent(term))
        .then(r => r.json())
        .then(data => {

            contenedor.insertAdjacentHTML("beforeend", data.html);

            skeleton.style.display = "none";
            window.hasNext = false;
        });

    }, 300));

    // ============ SCROLL INFINITO ===============
    window.addEventListener("scroll", function() {

        if (modoBusqueda) return;
        if (!window.hasNext) return;

        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 200) {
            cargarPagina(window.nextPage);
        }
    });

});
</script>









{% endblock %}
