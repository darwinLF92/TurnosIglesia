{% extends 'aplicacion/base.html' %}
{% load auth_extras %} 
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'aplicacion/css/lista_marchas.css' %}">

<div class="container mt-4">
    
    <div class="d-flex justify-content-between align-items-center mb-3">
          {% if perms.establecimiento.crear_registro %}
        <h2 class="page-title mb-0">üéº Marchas F√∫nebres</h2>
        <a href="{% url 'aplicacion:subir_marcha' %}" class="btn btn-primary">
            <i class="bx bx-upload"></i> Subir nueva marcha
        </a>
          {% endif %}
    </div>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

        <form method="GET" action="{% url 'aplicacion:lista_marchas' %}" class="search-bar">
        <input id="searchInput" type="text" name="q" class="form-control"
                placeholder="Buscar marchas..." value="{{ query }}" autocomplete="off">
        </form>


    <div class="filtro-tabs">
    <a href="?filtro=todas{% if query %}&q={{ query|urlencode }}{% endif %}"
        class="{% if filtro == 'todas' %}active{% endif %}">
          üéµ Todas
        <span class="tab-count">{{ total_todas }}</span>
    </a>

    <a href="?filtro=favoritas{% if query %}&q={{ query|urlencode }}{% endif %}"
        class="{% if filtro == 'favoritas' %}active{% endif %}">
         ‚ù§Ô∏è  Favoritas
        {% if user.is_authenticated %}
        <span class="tab-count">{{ total_favoritas }}</span>
        {% endif %}
    </a>
    </div>

    <div class="row">
        <!-- Lista de marchas -->
        <div class="col-md-4">
            <div class="list-group marchas-scroll-container">
                {% for marcha in marchas %}
                <div class="list-group-item" id="marcha_{{ marcha.id }}"
                data-title="{{ marcha.titulo|lower }}">
                    {% if marcha.imagen_portada %}
                        <img src="{{ marcha.imagen_portada.url }}" alt="{{ marcha.titulo }}">
                    {% else %}
                        <img src="/media/imagenes_marchas/Portada_default.webp" alt="Sin portada">
                    {% endif %}
                    
                    <span class="flex-grow-1">{{ marcha.titulo }}</span>
                      {% if perms.establecimiento.eliminar_registro %}
                    <a href="#" class="btn-delete" title="Eliminar" data-marchaid="{{ marcha.id }}">
                        <i class="fas fa-trash-alt"></i>
                    </a>
                    {% endif %}
                     {% if perms.establecimiento.editar_registro %}
                    <a href="#" class="editar-btn" title="Editar" data-marchaid="{{ marcha.id }}" onclick="event.stopPropagation();"><i class="fas fa-edit"></i></a>
                    {% endif %}
                    <button
                    onclick="reproducirMarcha('{% url 'aplicacion:serve_audio' marcha.audio.name %}', '{{ marcha.titulo|escapejs }}', '{{ marcha.descripcion|default:''|escapejs }}', '{% if marcha.imagen_portada %}{{ marcha.imagen_portada.url }}{% else %}/media/imagenes_marchas/Portada_default.webp{% endif %}', '{{ marcha.id }}')"
                    class="btn btn-sm btn-outline-secondary me-2"
                    title="Reproducir">
                    ‚ñ∂
                    </button>
                

                    <button onclick="toggleFavoritoLista({{ marcha.id }})"
                            class="favorite-btn"
                            id="favoritoBtnLista_{{ marcha.id }}"
                            title="Favorito">
                        <i class="fa fa-heart {% if marcha.id in favoritas_usuario %}text-danger{% endif %}"></i>
                    </button>
                </div>
                {% empty %}
                    <p>No hay marchas registradas.</p>
                {% endfor %}
            </div>

        </div>

        <!-- Reproductor -->
        <div class="col-md-8">
            <div class="audio-card" id="reproductorCard" style="display: none;">
                <!-- dentro de .audio-card, por ejemplo al inicio -->
                <button id="minimizarPlayer" class="btn-minimizar" aria-label="Minimizar reproductor" title="Minimizar">
                <i class="fa-solid fa-chevron-left"></i>
                </button>

                <img id="portadaMarcha" src="" class="portadaMarcha">
                
                <div class="audio-wrapper">
               <div class="titulo-favorito">
                    <h4 id="tituloMarcha" class="mb-0"></h4>

                    <button class="favorite-btn ms-2"
                            id="favoritoBtnReproductor"
                            title="Favorito">
                        <i id="iconoFavorito" class="fa fa-heart"></i>
                    </button>
                </div>

                <p id="descripcionMarcha" class="text-muted mt-1"></p>


                    <audio id="audioPlayer" controls style="width: 100%;">
                        <source id="audioSource" src="" type="audio/mpeg">
                        Tu navegador no soporta la reproducci√≥n de audio.
                    </audio>

                    <!-- Controles adicionales -->
                    <div class="controles-extra mt-2">
                        <button onclick="retrocederMarcha()">‚èÆ Anterior</button>
                        <button onclick="detenerMarcha()">‚èπ Detener</button>
                        <button onclick="siguienteMarcha()">‚è≠ Siguiente</button>
                        <!-- Bot√≥n de repetir con 4 estados -->
                        <button id="btnRepetir" onclick="toggleRepetir()" title="Repetir">
                            <div style="position: relative;">
                                <i id="iconoRepetir" class="fa-solid fa-repeat fa-inactive"></i>
                                <span id="badgeRepetir" class="repeat-badge">1</span>
                            </div>
                        </button>
                        

                        <!-- Bot√≥n de aleatorio con 2 estados -->
                        <button id="btnAleatorio" onclick="toggleAleatorio()" title="Aleatorio">
                            <i id="iconoAleatorio" class="fa-solid fa-shuffle fa-inactive"></i>
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


<script>
  const USER_AUTH = {{ request.user.is_authenticated|yesno:"true,false" }};
</script>

<script src="{% static 'aplicacion/css/js/lista_marchas.js' %}"></script>



{% endblock %}
