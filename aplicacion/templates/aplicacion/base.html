{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Hermandad Aldea El Ingeniero{% endblock %}</title>

    <!-- Bootstrap 5.3 y Boxicons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/boxicons/css/boxicons.min.css">
    <link rel="stylesheet" href="{% static 'aplicacion/css/base.css' %}">
    <link rel="icon" href="{% static 'favicon.ico' %}" type="image/x-icon">
    <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    {% block extra_css %}{% endblock %}
</head>

<body>
    <!-- Contenedor principal -->
    <div class="container-fluid p-0">

      <!-- NAVBAR SUPERIOR -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
  <div class="container-fluid">

    <!-- Logo / Home -->
    <a href="{% url 'aplicacion:home' %}" class="navbar-brand brand-logo" aria-label="Inicio">
      <img src="{% static 'logos/home.png' %}" alt="Inicio" width="50" height="50">
      <span class="d-none d-sm-inline ms-2"></span>
    </a>

<!-- üîπ Contenedor m√≥vil: Perfil + Men√∫ -->
<!-- üîπ Contenedor m√≥vil: Notificaciones + Perfil + Men√∫ -->
<div class="d-flex d-lg-none ms-auto align-items-center gap-3">

    <!-- üîî NOTIFICACIONES EN M√ìVIL -->
     {% if user.is_authenticated %}
    <div class="dropdown">
        <a class="nav-link position-relative" href="#" id="mobileNotifDropdown"
           data-bs-toggle="dropdown" aria-expanded="false">

            <i class="bx bx-bell" style="font-size:22px;"></i>

            {% if notif_total_no_leidas > 0 %}
            <span class="notif-badge">
                {{ notif_total_no_leidas }}
            </span>
            {% endif %}
        </a>

        <ul class="dropdown-menu dropdown-menu-end notif-menu shadow"
            aria-labelledby="mobileNotifDropdown">

            <li class="notif-header">Notificaciones</li>

            {% if notif_no_leidas %}
                {% for n in notif_no_leidas %}
                <li>
                    <a href="{% url 'noticias:leer_notificacion' n.id %}"
                       class="dropdown-item notif-item notif-unread">
                        {{ n.texto }}<br>
                        <small class="notif-date">{{ n.creado_en|date:"d/m/Y H:i" }}</small>
                    </a>
                </li>
                {% endfor %}
            {% else %}
                <li class="dropdown-item notif-item notif-empty">
                    Sin notificaciones
                </li>
            {% endif %}

            {% if notif_historial %}
            <li><hr class="dropdown-divider"></li>
            <li class="dropdown-header historial-notif small">Historial reciente</li>

            {% for n in notif_historial %}
            <li>
                <a href="{% url 'noticias:leer_notificacion' n.id %}"
                   class="dropdown-item notif-item {% if not n.leido %}notif-unread{% else %}notif-read{% endif %}">
                    {{ n.texto }}<br>
                    <small class="notif-date">{{ n.creado_en|date:"d/m/Y H:i" }}</small>
                </a>
            </li>
            {% endfor %}
            {% endif %}
        </ul>
    </div>

    <!-- üë§ PERFIL EN M√ìVIL -->
    <div class="dropdown">
        <a class="nav-link p-0" href="#" id="mobileUserDropdown" data-bs-toggle="dropdown">
            {% if user.perfil.foto_perfil %}
                <img src="{{ user.perfil.foto_perfil.url }}" class="rounded-circle"
                     width="32" height="32" style="object-fit:cover;">
            {% else %}
                <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center"
                     style="width:32px; height:32px;">
                    {{ user.first_name|default:user.username|slice:":1" }}
                </div>
            {% endif %}
        </a>

        <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="mobileUserDropdown">
            <li><a class="dropdown-item" href="{% url 'cuentas:perfil' %}"><i class="bx bx-user me-2"></i> Perfil</a></li>
            <li><a class="dropdown-item" href="{% url 'cuentas:editar_perfil' %}"><i class="bx bx-edit me-2"></i> Editar perfil</a></li>
            <li><a class="dropdown-item" href="{% url 'inscripciones_online:mis_inscripciones' %}"><i class='bx  bx-check-circle'></i>  Mis Inscripciones</a></li>
            <li><a class="dropdown-item" href="{% url 'cuentas:cambiar_password' %}"><i class="bx bx-key me-2"></i> Cambiar contrase√±a</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item text-danger" href="{% url 'aplicacion:logout' %}">
                <i class="bx bx-log-out me-2"></i> Cerrar sesi√≥n
            </a></li>
        </ul>
    </div>
    {% endif %}

    <!-- üçî MEN√ö HAMBURGUESA -->
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
            data-bs-target="#navbarContenido">
        <span class="navbar-toggler-icon"></span>
    </button>
</div>



    <!-- Contenido del men√∫ -->
    <div class="collapse navbar-collapse" id="navbarContenido">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">

        {% if user.is_authenticated %}

          {# MANTENEDOR #}
          {% if perms.establecimiento.acceso_mantenedor %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
              <i class="bx bx-cog me-1"></i> Mantenedor
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="{% url 'usuarios:lista_usuarios' %}">Usuarios</a></li>
              <li><a class="dropdown-item" href="{% url 'usuarios:lista_roles' %}">Roles</a></li>
            </ul>
          </li>
          {% endif %}

          {# ESTABLECIMIENTO #}
          {% if perms.establecimiento.acceso_establecimiento %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
              <i class="bx bx-building-house me-1"></i> Establecimiento
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="{% url 'establecimiento:lista_establecimientos' %}">Datos generales</a></li>
              <li><a class="dropdown-item" href="{% url 'aplicacion:configuracion_home_list' %}">Configuraci√≥n del Home</a></li>
            </ul>
          </li>
          {% endif %}

          {# PROCESIONES #}
          {% if perms.establecimiento.acceso_procesiones %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
              <i class="bx bx-church me-1"></i> Procesiones
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="{% url 'procesiones:lista_procesiones' %}">Listado de procesiones</a></li>
              {% if perms.establecimiento.acceso_turnos %}
              <li><a class="dropdown-item" href="{% url 'turnos:lista_turnos' %}">Gesti√≥n de turnos</a></li>
              {% endif %}
            </ul>
          </li>
          {% endif %}


          {# DEVOTOS #}
          {% if perms.establecimiento.acceso_devotos %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
              <i class="bx bx-user-circle me-1"></i> Devotos
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="{% url 'devotos:lista_devotos' %}">Listado de devotos</a></li>
            </ul>
          </li>
          {% endif %}

          {# INSCRIPCIONES #}
          {% if perms.establecimiento.acceso_inscripciones %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
              <i class="bx bx-file me-1"></i> Inscripciones
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="{% url 'gestion_turnos:lista_inscripciones' %}">Incribir Devotos</a></li>
               {% if perms.establecimiento.acceso_gestion_entrega %}
              <li><a class="dropdown-item" href="{% url 'gestion_turnos:lista_entrega_turnos' %}">Gesti√≥n de Entrega</a></li>
               {% endif %}
            </ul>
          </li>
          {% endif %}
      {% endif %}
          <li class="nav-item">
            <a class="nav-link" href="{% url 'noticias:muro' %}">
              <i class="bx bx-news me-1"></i> Noticias
            </a>
          </li>        
      </ul>
{% if user.is_authenticated %}
      <ul class="navbar-nav ms-auto align-items-lg-center">
        <!-- CAMPANA DE NOTIFICACIONES -->
<!-- CAMPANA DE NOTIFICACIONES -->
<!-- CAMPANA DE NOTIFICACIONES -->
<li class="nav-item dropdown notif-dropdown me-3 d-none d-lg-block"">
    <a class="nav-link position-relative"
       href="#"
       id="notifDropdown"
       data-bs-toggle="dropdown"
       aria-expanded="false">

        <i class="bx bx-bell" style="font-size:22px;"></i>

        {# contador solo de NO le√≠das #}
        {% if notif_total_no_leidas > 0 %}
            <span class="notif-badge">
                {{ notif_total_no_leidas }}
            </span>
        {% endif %}
    </a>

    <ul class="dropdown-menu dropdown-menu-end notif-menu shadow">
        <li class="notif-header">Notificaciones</li>

        {# üî• Si HAY no le√≠das, las mostramos #}
        {% if notif_no_leidas %}
            {% for n in notif_no_leidas %}
            <li>
                <a href="{% url 'noticias:leer_notificacion' n.id %}"
                   class="dropdown-item notif-item notif-unread">
                    {{ n.texto }}<br>
                    <small class="notif-date">
                        {{ n.creado_en|date:"d/m/Y H:i" }}
                    </small>
                </a>
            </li>
            {% endfor %}

        {# ‚ùå Si NO hay ninguna no le√≠da, mensaje vac√≠o #}
        {% else %}
            <li class="dropdown-item notif-item notif-empty">
                Sin notificaciones
            </li>
        {% endif %}

        {% if notif_historial %}
        <li><hr class="dropdown-divider"></li>
       <li class="dropdown-header historial-notif small">Historial reciente</li>

        {% for n in notif_historial %}
        <li>
            <a href="{% url 'noticias:leer_notificacion' n.id %}"
               class="dropdown-item notif-item {% if not n.leido %}notif-unread{% else %}notif-read{% endif %}">
                {{ n.texto }}<br>
                <small class="notif-date">{{ n.creado_en|date:"d/m/Y H:i" }}</small>
            </a>
        </li>
        {% endfor %}

        {% endif %}
    </ul>
</li>
{% endif %}




      <!-- DERECHA: usuario / salir -->
      <ul class="navbar-nav ms-auto align-items-lg-center">
        {% if user.is_authenticated %}
          <!-- MENU DESPLEGABLE DE USUARIO -->
          <li class="nav-item dropdown me-2 d-none d-lg-block">

            <a class="nav-link dropdown-toggle d-flex align-items-center"
              href="#"
              id="userDropdown"
              role="button"
              data-bs-toggle="dropdown"
              aria-expanded="false">

                {% if user.perfil.foto_perfil %}
                  <img src="{{ user.perfil.foto_perfil.url }}"
                      class="rounded-circle me-2"
                      width="32" height="32">
                {% else %}
                  <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-2"
                      style="width:32px; height:32px;">
                    {{ user.first_name|default:user.username|slice:":1" }}
                  </div>
                {% endif %}

                <span class="small fw-semibold">
                  {{ user.first_name|default:user.username }}
                </span>
            </a>

            <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="userDropdown">
                <li>
                  <a class="dropdown-item" href="{% url 'cuentas:perfil' %}">
                    <i class="bx bx-user me-2"></i> Ver mi perfil
                  </a>
                </li>

                <li>
                  <a class="dropdown-item" href="{% url 'cuentas:editar_perfil' %}">
                    <i class="bx bx-edit me-2"></i> Editar perfil
                  </a>
                </li>

                <li>
                  <a class="dropdown-item" href="{% url 'cuentas:cambiar_password' %}">
                    <i class="bx bx-key me-2"></i> Cambiar contrase√±a
                  </a>
                </li>
                
                <li>
                  <a class="dropdown-item" href="{% url 'inscripciones_online:mis_inscripciones' %}">
                    <i class='bx  bx-check-circle'></i>  Mis Inscripciones
                  </a>
                </li>

                <li><hr class="dropdown-divider"></li>

                <li>
                  <a class="dropdown-item text-danger" href="{% url 'aplicacion:logout' %}">
                    <i class="bx bx-log-out me-2"></i> Cerrar sesi√≥n
                  </a>
                </li>
            </ul>
          </li>

        {% else %}
          <li class="nav-item">
            <a class="nav-link" href="{% url 'aplicacion:login' %}">
              <i class="bx bx-log-in"></i> Acceder
            </a>
          </li>
        {% endif %}
      </ul>
    </div>
  </div>
</nav>

      <!-- Carrusel a pantalla completa -->
      {% block carrusel_fullscreen %}{% endblock %}

      <!-- Contenido principal -->
      <main class="container mt-5 pt-4">
          {% block content %}{% endblock %}
      </main>
    </div>

    <!-- Bootstrap JS 5.3 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- JS personalizado -->
    <script src="{% static 'index/js/base.js' %}"></script>

    {% block extra_js %}{% endblock %}

    <!-- SCRIPT: Cerrar men√∫ al hacer clic fuera (m√≥vil / colapsado) -->
    <script>
      document.addEventListener('click', function (event) {
        const navbar = document.getElementById('navbarContenido');
        const toggler = document.querySelector('.navbar-toggler');

        if (!navbar) return;

        const isOpen = navbar.classList.contains('show');
        const clickInsideNavbar = navbar.contains(event.target);
        const clickOnToggler = toggler && toggler.contains(event.target);

        if (isOpen && !clickInsideNavbar && !clickOnToggler) {
          const bsCollapse = bootstrap.Collapse.getInstance(navbar);
          if (bsCollapse) {
            bsCollapse.hide();
          }
        }
      });
    </script>

    <!-- SCRIPT: Mensaje de bienvenida -->
{% if user.is_authenticated and messages %}
<script>
document.addEventListener('DOMContentLoaded', () => {

    {% for message in messages %}
        {% if 'bienvenida' in message.tags %}
        
            const toast = document.getElementById("toast-bienvenida");
            const texto = document.getElementById("toast-texto");

            texto.textContent = "{{ message|escapejs }}";

            // Mostrar toast
            toast.classList.add("mostrar");

            // Ocultar despu√©s de 3 segundos
            setTimeout(() => {
                toast.classList.remove("mostrar");
            }, 3000);

        {% endif %}
    {% endfor %}

});
</script>
{% endif %}


    <style>
:root{
  --brand-size-desktop: 65px;   /* antes 48 */
  --brand-size-mobile: 50px;    /* antes 40 */
  --brand-radius: 10px;
}


/* ALTURA CORRECTA DEL NAVBAR (Bootstrap Default 56px) */
.navbar {
    min-height: 56px !important;
    padding-top: 5px !important;
    padding-bottom: 5px !important;
}

/* Centrar verticalmente los textos y dropdowns */
.navbar .nav-link,
.navbar .dropdown-toggle,
.navbar .navbar-brand {
    display: flex;
    align-items: center;
    height: 60px;  /* misma altura que navbar */
}


/* Logo */
.navbar .brand-logo img {
    width: var(--brand-size-desktop);
    height: var(--brand-size-desktop);
    object-fit: contain;
}

      @media (max-width: 576px){
        .navbar .brand-logo img{
          width: var(--brand-size-mobile);
          height: var(--brand-size-mobile);
        }
      }

      /* Footer */
      .site-footer {
        background: #081d4400;
        color: #0e153b;
        text-align: center;
        font-size: 0.9rem;
        padding: 16px 8px;
        border-top: 3px solid #39415000;
      }

      .site-footer p {
        margin: 0;
        line-height: 1.6;
      }

      .site-footer a {
        color: #052daf;
        text-decoration: none;
        transition: color 0.3s ease;
      }

      .site-footer a:hover {
        color: #052daf;
        text-decoration: underline;
      }

      @media (max-width: 576px) {
        .site-footer {
          font-size: 0.8rem;
          padding: 12px 6px;
        }
        .site-footer p {
          display: flex;
          flex-direction: column;
          gap: 4px;
        }
      }

/* ===== TOAST BIENVENIDA - GLASS EFFECT ===== */
.toast-bienvenida {
    position: fixed;
    top: 60px;
    left: 50%;
    transform: translateX(-50%) translateY(-40px);

    /* üé® GLASS EFFECT */
    background: rgba(255, 255, 255, 0.22);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.25);

    /* Estilo del toast */
    color: #222;
    padding: 14px 24px;
    border-radius: 18px;
    font-size: 1rem;
    font-weight: 600;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);

    opacity: 0;
    transition: all 0.5s ease;
    z-index: 9999;
    pointer-events: none;
}

.toast-bienvenida.mostrar {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
}

/* ============================================= */
/*  PERFIL MEN√ö GLASS EFFECT                     */
/* ============================================= */

.dropdown-menu {
    background: rgba(255, 255, 255, 0.10) !important;
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    
    border: 1px solid rgba(255, 255, 255, 0.18);
    border-radius: 14px;

    padding: 8px 0;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.35);
    animation: fadeInMenu 0.18s ease-out;
}

/* Animaci√≥n suave */
@keyframes fadeInMenu {
    from { opacity: 0; transform: translateY(-8px); }
    to   { opacity: 1; transform: translateY(0); }
}

/* √çtems del men√∫ */
.dropdown-item {
    color: #000000 !important;
    font-size: 0.94rem;
    padding: 10px 18px;
    display: flex;
    align-items: center;
    gap: 10px;

    border-radius: 8px;
    transition: 0.25s ease;
}

/* Hover elegante */
.dropdown-item:hover {
    background: rgba(255, 255, 255, 0.14);
    color: #ffffff !important;
}

/* √çconos */
.dropdown-item i {
    font-size: 1.1rem;
    opacity: 0.85;
}

/* Separador m√°s suave */
.dropdown-divider {
    border-color: rgba(255, 255, 255, 0.15);
    margin: 6px 0;
}

/* ===== CERRAR SESI√ìN ===== */
.dropdown-item.text-danger {
    color: #ff6f6f !important;
    font-weight: 600;
}

.dropdown-item.text-danger i {
    color: #ff6f6f !important;
}

.dropdown-item.text-danger:hover {
    background: rgba(255, 60, 60, 0.18);
    color: #ff9c9c !important;
}

/* Evita que el men√∫ se pegue demasiado al avatar */
.dropdown-menu-end {
    margin-top: 8px !important;
}



/* ========================================== */
/*         üîî NOTIFICACIONES PERSONALIZADO    */
/* ========================================== */

/* Contenedor del badge rojo */
.notif-badge {
    background-color: #dc3545;
    color: #fff;
    font-size: 10px;
    padding: 3px 6px;
    border-radius: 50%;
    position: absolute;
    top: 0;
    right: -5px;
}

/* Menu de notificaciones */
.notif-menu {
    background: #1e1e1e !important;
    width: 300px !important;
    max-height: 400px;
    overflow-y: auto;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.15);
    padding: 0;
}

/* T√≠tulo del dropdown */
.notif-header {
    font-weight: bold;
    color: #fff;
    padding: 12px 15px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    font-size: 15px;
}

/* Elemento de notificaci√≥n */
.notif-item {
    padding: 10px 15px !important;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    white-space: normal !important;
}

/* No le√≠das */
.notif-unread {
    font-weight: 600 !important;
    color: #909ff7 !important;
    background: rgba(255,255,255,0.06);
}

/* Le√≠das */
.notif-read {
    font-weight: 400 !important;
    color: #bfbfbf !important;
}

/* Fecha */
.notif-date {
    color: #9c9c9c !important;
}

/* Mensaje vac√≠o */
.notif-empty {
    color: #999 !important;
}

/* Hover */
.notif-item:hover {
    background: rgba(255,255,255,0.1) !important;
    color: #fff !important;
}

/* Evitar blur heredado del carrusel */
.notif-menu * {
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
}

.historial-notif {
    color: wheat
    }
/* Alinear perfil + men√∫ hamburguesa en m√≥vil */
/* Alinear bien iconos del men√∫ m√≥vil */
/* --- CENTRAR DROPDOWN DE NOTIFICACIONES EN MOVIL --- */
/* üí¨ Notificaciones versi√≥n m√≥vil: ancho m√°s grande y centrado */
@media (max-width: 768px) {

    /* Notificaciones */
    .notif-menu {
        position: fixed !important;
        top: 65px !important;
        left: 50% !important;
        transform: translateX(-50%) !important;
        width: 95% !important;
        max-width: 500px !important;
        border-radius: 12px !important;
        z-index: 9999 !important;
    }

 .user-menu-mobile {
        position: fixed !important;
        top: 65px !important;
        right: 10px !important;   /* Separa un poco del borde */
        left: auto !important;    /* Quita el centrado */
        transform: none !important;
        width: 260px !important;  /* Ancho del men√∫ */
        border-radius: 12px !important;
        z-index: 9999 !important;
    }

    /* El men√∫ NO debe quedar pegado al toggler */
    .navbar-nav.ms-auto {
        flex-direction: row;
        align-items: center;
        gap: 10px;
    }

    /* √çconos m√≥viles m√°s grandes */
    .navbar .nav-link.mobile-icon {
        padding: 6px 10px !important;
        font-size: 20px !important;
    }

}



    </style>
</body>

<div id="toast-bienvenida" class="toast-bienvenida">
    <span id="toast-texto"></span>
</div>

<footer class="site-footer">
  <p>
    <strong>DMLR System</strong>
    {% if system_meta.VERSION %} - v{{ system_meta.VERSION }}{% endif %}
    &nbsp;|&nbsp; ¬© {{ system_meta.ORG_NAME }}
    &nbsp;|&nbsp; Desarrollado por
    <a href="{{ system_meta.AUTHOR_LINK }}" target="_blank" rel="noopener">
      {{ system_meta.AUTHOR_NAME }}
    </a>
    {% if system_meta.AUTHOR_PHONE %}
      &nbsp;|&nbsp; Contacto: {{ system_meta.AUTHOR_PHONE }}
    {% endif %}
  </p>
</footer>
</html>
