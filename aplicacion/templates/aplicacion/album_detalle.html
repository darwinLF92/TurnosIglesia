{% extends 'aplicacion/base.html' %}
{% load static %}
{% block title %}{{ album.titulo }}{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="fw-bold mb-0">{{ album.titulo }}</h3>
    <div class="d-flex gap-2 flex-wrap">
      {% if album.tipo == 'foto' and perms.aplicacion.add_foto %}
        <a href="{% url 'aplicacion:album_foto_subir' album.pk %}" class="btn btn-primary btn-sm">Subir fotos</a>
      {% endif %}
      {% if album.tipo == 'video' and perms.aplicacion.add_video %}
        <a href="{% url 'aplicacion:album_video_subir' album.pk %}" class="btn btn-primary btn-sm">Subir video</a>
      {% endif %}
      <a href="{% url 'aplicacion:galeria' %}" class="btn btn-secondary btn-sm">Ir a Galería</a>
    </div>
  </div>

  <p class="text-muted">{{ album.descripcion }}</p>

{% if album.tipo == 'foto' %}
  <div class="gallery-grid">
    {% for f in album.fotos.all %}
      <figure class="shot group-thumb">
        {% if request.user.is_authenticated %}
          <div class="thumb-actions">
            <a href="{% url 'aplicacion:foto_editar' f.pk %}" class="btn btn-light btn-sm">Editar</a>
            <a href="{% url 'aplicacion:foto_eliminar' f.pk %}" class="btn btn-danger btn-sm">Eliminar</a>
          </div>
        {% endif %}

        <img
          src="{{ f.imagen.url }}"
          alt="{{ f.titulo }}"
          class="shot-img gallery-image"
          loading="lazy"
          decoding="async"
          data-type="image"
          data-src="{{ f.imagen.url }}"
          data-caption="{{ f.titulo|default:'' }}"
        >

        {% if f.titulo %}
        <figcaption class="shot-cap">
          <span class="text-truncate">{{ f.titulo }}</span>
        </figcaption>
        {% endif %}
      </figure>
    {% empty %}
      <div class="alert alert-info">Aún no hay fotos en este álbum.</div>
    {% endfor %}
  </div>


  {% else %}
    <div class="row g-3">
      {% for v in album.videos.all %}
        {% with thumb=v.thumbnail_url %}
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-body p-2">
              <div class="position-relative group-thumb">
                <!-- Botones overlay (solo autenticado) -->
                {% if request.user.is_authenticated %}
                  <div class="thumb-actions">
                    <a href="{% url 'aplicacion:video_editar' v.pk %}" class="btn btn-light btn-sm">Editar</a>
                    <a href="{% url 'aplicacion:video_eliminar' v.pk %}" class="btn btn-danger btn-sm">Eliminar</a>
                  </div>
                {% endif %}

                <!-- Tarjeta clickable con imagen de portada -->
                <div class="video-thumb rounded overflow-hidden"
                     style="
                       height:240px;
                       background:#000 url('{% if thumb %}{{ thumb }}{% else %}{% static 'imagenes/video_placeholder.jpg' %}{% endif %}')
                       center/cover no-repeat;
                       cursor:pointer;"
                     data-type="{% if v.url %}video-url{% else %}video-file{% endif %}"
                     data-src="{% if v.url %}{{ v.embed_src }}{% else %}{{ v.archivo.url }}{% endif %}"
                     data-caption="{{ v.titulo|default:'' }}">
                  <div class="w-100 h-100 d-flex align-items-center justify-content-center text-white"
                       style="background:rgba(0,0,0,.25)">
                    <i class="fas fa-play-circle" style="font-size:64px; filter: drop-shadow(0 2px 6px rgba(0,0,0,.6));"></i>
                  </div>
                </div>
              </div>

              {% if v.titulo %}<div class="small mt-2 text-muted">{{ v.titulo }}</div>{% endif %}
            </div>
          </div>
        </div>
        {% endwith %}
      {% empty %}
        <div class="alert alert-info">Aún no hay videos en este álbum.</div>
      {% endfor %}
    </div>
  {% endif %}
</div>

<!-- ========== MODAL UNIVERSAL (fotos + videos) ========== -->
<div id="lightboxModal" class="lb-modal">
  <button type="button" class="lb-close" aria-label="Cerrar">&times;</button>

  <!-- Flechas de navegación (solo se muestran para imágenes) -->
  <button type="button" class="lb-nav lb-prev" aria-label="Anterior">‹</button>
  <button type="button" class="lb-nav lb-next" aria-label="Siguiente">›</button>

  <!-- Contenido imagen -->
  <img id="lbImage" class="lb-media" alt="">

  <!-- Contenido video por URL (iframe) -->
  <div id="lbIframeWrap" class="lb-media">
    <iframe id="lbIframe" title="video" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
  </div>

  <!-- Contenido video archivo -->
  <video id="lbVideo" class="lb-media" controls></video>

  <div id="lbCaption" class="lb-caption"></div>
</div>

<style>
/* Modal base */
  .lb-modal{
    display:none; position:fixed; inset:0; z-index:9999;
    background:rgba(0,0,0,.9);
    padding:60px 20px 20px;
  }
  .lb-media{
    display:none; margin:0 auto; max-width:92vw; max-height:78vh; border-radius:12px;
    box-shadow:0 0 18px rgba(255,255,255,.15);
  }
  #lbImage{ object-fit:contain; width:auto; height:auto; }
  #lbIframeWrap{ width:min(92vw, 1200px); height:min(78vh, 675px); }
  #lbIframe{ width:100%; height:100%; border:0; border-radius:12px; }
  #lbVideo{ width:min(92vw, 1200px); max-height:78vh; }

  .lb-close{
    position:absolute; top:18px; right:24px; font-size:40px; line-height:1;
    border:none; background:transparent; color:#fff; cursor:pointer;
    transition:opacity .2s ease;
  }
  .lb-close:hover{ opacity:.75; }

  .lb-caption{
    margin:16px auto 0; max-width:92vw; color:#ddd; text-align:center; font-size:0.95rem;
  }

  /* Flechas navegación */
  .lb-nav{
    position:absolute; top:50%; transform:translateY(-50%);
    width:52px; height:52px; border:0; border-radius:999px;
    background:rgba(255,255,255,.18); color:#fff; font-size:34px;
    display:none; align-items:center; justify-content:center;
    cursor:pointer; user-select:none;
  }
  .lb-prev{ left:16px; }
  .lb-next{ right:16px; }
  .lb-nav:active{ transform:translateY(calc(-50% + 1px)); }
  /* Se muestran solo cuando hay imagen */
  .lb-modal.lb-showing-image .lb-nav{ display:flex; }

  /* thumb videos (ícono play centrado) */
  .video-thumb .fa-play-circle { filter: drop-shadow(0 2px 6px rgba(0,0,0,.6)); }
</style>
<style>
  /* Overlay elegante que aparece al pasar el mouse (desktop) o siempre visible en mobile */
  .group-thumb { position: relative; }
  .thumb-actions {
    position: absolute; top: 8px; right: 8px; z-index: 2;
    display: flex; gap: .4rem; opacity: 0; transition: opacity .15s ease;
  }
  .group-thumb:hover .thumb-actions { opacity: 1; }
  @media (max-width: 768px) {
    .thumb-actions { opacity: 1; }
  }
</style>

<script>
(function(){
  const modal      = document.getElementById('lightboxModal');
  const closeBtn   = modal.querySelector('.lb-close');
  const prevBtn    = modal.querySelector('.lb-prev');
  const nextBtn    = modal.querySelector('.lb-next');

  const imgEl      = document.getElementById('lbImage');
  const iframeWrap = document.getElementById('lbIframeWrap');
  const iframeEl   = document.getElementById('lbIframe');
  const videoEl    = document.getElementById('lbVideo');
  const captionEl  = document.getElementById('lbCaption');

  // --- Colección de imágenes de la galería y posición actual ---
  const galleryEls = Array.from(document.querySelectorAll('.gallery-image'));
  const gallery = galleryEls.map(el => ({
    src: el.dataset.src || el.src,
    caption: el.dataset.caption || el.alt || ''
  }));
  let currentIndex = -1;

  function hideAll(){
    imgEl.style.display = 'none';
    iframeWrap.style.display = 'none';
    videoEl.style.display = 'none';
    iframeEl.src = '';
    try { videoEl.pause(); videoEl.src = ''; } catch(e){}
    modal.classList.remove('lb-showing-image'); // oculta flechas
  }

  function openModal(){
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
  }
  function closeModal(){
    hideAll();
    modal.style.display = 'none';
    document.body.style.overflow = '';
    currentIndex = -1;
  }

  // ---- Mostrar imagen segun índice (con loop circular) ----
  function showImageAt(i){
    if (!gallery.length) return;
    currentIndex = (i + gallery.length) % gallery.length;
    const item = gallery[currentIndex];
    hideAll();
    imgEl.src = item.src;
    imgEl.alt = item.caption;
    imgEl.style.display = 'block';
    captionEl.textContent = item.caption;
    modal.classList.add('lb-showing-image'); // muestra flechas
    openModal();
  }

  function nextImage(){ if (currentIndex >= 0) showImageAt(currentIndex + 1); }
  function prevImage(){ if (currentIndex >= 0) showImageAt(currentIndex - 1); }

  // Abre imagen (reemplaza tu handler anterior)
  galleryEls.forEach((el, i)=>{
    el.addEventListener('click', ()=> showImageAt(i));
  });

  // Abre video por URL (YouTube/Vimeo)
  document.querySelectorAll('.video-thumb[data-type="video-url"]').forEach(el=>{
    el.addEventListener('click', ()=>{
      const raw = el.dataset.src || '';
      const cap = el.dataset.caption || '';
      let src = raw;
      if (/^https?:\/\/(www\.)?youtube\.com\/watch\?v=/.test(raw)) {
        const vid = new URL(raw).searchParams.get('v');
        src = `https://www.youtube.com/embed/${vid}?autoplay=1`;
      } else if (/^https?:\/\/youtu\.be\//.test(raw)) {
        const vid = raw.split('/').pop();
        src = `https://www.youtube.com/embed/${vid}?autoplay=1`;
      }
      hideAll();
      iframeEl.src = src;
      iframeWrap.style.display = 'block';
      captionEl.textContent = cap;
      openModal();
    });
  });

  // Abre video de archivo
  document.querySelectorAll('.video-thumb[data-type="video-file"]').forEach(el=>{
    el.addEventListener('click', ()=>{
      const src = el.dataset.src || el.getAttribute('src');
      const cap = el.dataset.caption || '';
      hideAll();
      videoEl.src = src;
      videoEl.style.display = 'block';
      captionEl.textContent = cap;
      openModal();
      setTimeout(()=>{ try{ videoEl.play(); }catch(e){} }, 80);
    });
  });

  // Cerrar
  closeBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });

  // Navegación con flechas (solo si se está viendo imagen)
  prevBtn.addEventListener('click', prevImage);
  nextBtn.addEventListener('click', nextImage);

  // Teclado
  window.addEventListener('keydown', (e)=>{
    if (modal.style.display !== 'block') return;
    if (e.key === 'Escape') return closeModal();
    if (!modal.classList.contains('lb-showing-image')) return;
    if (e.key === 'ArrowLeft')  prevImage();
    if (e.key === 'ArrowRight') nextImage();
  });

  // Swipe táctil para imágenes
  let startX = null, startY = null, touching = false;
  const SWIPE_MIN = 50; // px

  modal.addEventListener('touchstart', (e)=>{
    if (!modal.classList.contains('lb-showing-image')) return;
    const t = e.changedTouches[0];
    startX = t.clientX; startY = t.clientY; touching = true;
  }, {passive:true});

  modal.addEventListener('touchend', (e)=>{
    if (!touching || !modal.classList.contains('lb-showing-image')) return;
    const t = e.changedTouches[0];
    const dx = t.clientX - startX;
    const dy = t.clientY - startY;
    touching = false;

    // ignorar vertical dominante
    if (Math.abs(dy) > Math.abs(dx)) return;

    if (dx <= -SWIPE_MIN) nextImage();   // swipe izquierda -> siguiente
    if (dx >=  SWIPE_MIN) prevImage();   // swipe derecha  -> anterior
  }, {passive:true});
})();
</script>


<style>
/* ===== Grid fluido para fotos ===== */
.gallery-grid{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 14px;
}

/* Tarjeta de foto */
.shot{
  position:relative;
  overflow:hidden;
  border-radius:14px;
  background:#111;
  box-shadow: 0 8px 18px rgba(0,0,0,.08);
  margin:0;
}

/* Imagen con aspecto consistente: 3:2 (puedes cambiar a 4/3 o 1/1) */
.shot-img{
  width:100%;
  aspect-ratio: 3 / 2;
  object-fit: cover;
  transition: transform .35s ease, filter .35s ease;
  cursor: zoom-in;
  display:block;
}

/* Zoom/iluminado al pasar */
.shot:hover .shot-img{
  transform: scale(1.03);
  filter: saturate(1.05);
}

/* Overlay del título abajo */
.shot-cap{
  position:absolute;
  left:0; right:0; bottom:0;
  padding:.5rem .75rem;
  color:#fff;
  font-size:.9rem;
  background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.55) 90%);
  display:flex; align-items:center; min-height:44px;
}

/* Botones editar/eliminar arriba derecha */
.thumb-actions{
  position:absolute; top:8px; right:8px; z-index:2;
  display:flex; gap:.4rem; opacity:0;
  transition: opacity .15s ease;
}
.group-thumb:hover .thumb-actions{ opacity:1; }
@media (max-width: 768px){ .thumb-actions{ opacity:1; } }

/* Accesibilidad al teclado: resalta si se navega con tab al botón dentro */
.thumb-actions .btn:focus-visible{ outline:2px solid #0d6efd; outline-offset:2px; }
</style>

{% endblock %}
